datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  phone_number String?  @unique
  username     String   @unique
  firstName    String?
  lastName     String?
  password     String
  role         Role     @default(USER)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  profile      Profile?

  @@map("user")
}

model Profile {
  id        String   @id @default(uuid())
  bio       String?
  avatar    String?
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("profile")
}

enum Role {
  USER
  ADMIN
  MODERATOR
}

model MKategori {
  id_kategori Int      @id @default(autoincrement())
  nm_kategori String   @unique
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  mainStocks TMainStock[]
  rackPusdis MRackPusdis[]

  @@map("mkategori")
}

model MSatuan {
  id_satuan  Int      @id @default(autoincrement())
  nm_satuan  String   @unique
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  mainStocks TMainStock[]

  @@map("msatuan")
}

model MCabang {
  kd_cab            String    @id
  nm_cab            String    @db.VarChar(100)
  alamat            String?   @db.Text
  no_telepon        String?   @db.VarChar(20)
  no_hp             String?   @db.VarChar(20)
  email             String?   @db.VarChar(100)
  created_at        DateTime  @default(now())
  deleted_status    Boolean   @default(false)
  deleted_at        DateTime?
  id_tipe_cabang    Int?
  id_area           Int?
  shift             Int?
  id_instansi       Int?
  bpjs              Boolean   @default(false)
  status_connection Boolean   @default(true)
  offline           Boolean   @default(false)
  proses            Boolean   @default(false)
  tanggal_update    DateTime? @db.Date
  time_off          DateTime? @db.Time()

  // Relasi (uncomment dan sesuaikan jika tabel relasinya sudah ada)
  // tipe_cabang      MTipeCabang  @relation(fields: [id_tipe_cabang], references: [id])
  // area             MArea        @relation(fields: [id_area], references: [id])
  // instansi         MInstansi    @relation(fields: [id_instansi], references: [id])

  // Tambahkan relasi balik ke TMainStock
  mainStocks TMainStock[]
  Transaksi  Transaksi[]
  Antrian    Antrian[]

  @@map("mcabang")
}

model TMainStock {
  kd_brgdg                Int       @id @default(autoincrement())
  nm_brgdg                String
  id_dept                 Int?
  isi                     Int?
  id_satuan               Int?
  strip                   Int
  mark_up                 Float?
  hb_netto                Float?
  hb_gross                Float?
  hj_ecer                 Float?
  hj_bbs                  Float?
  id_kategori             Int?
  id_pabrik               Int?
  barcode                 String?
  created_at              DateTime  @default(now())
  created_by              String?
  deleted_status          Boolean   @default(false)
  deleted_at              DateTime?
  hpp                     Float?
  q_bbs                   Int?
  tgl_new_product         DateTime?
  konsinyasi              Boolean?
  halodoc                 Boolean?
  bpjs                    Boolean?
  informasi_po            String?
  informasi_tanggal_ed_po DateTime?
  aturan_pakai            String?
  komposisi               String?
  indikasi                String?
  dosis                   String?
  trading_term            String?
  id_kl                   Int?
  status                  Int?
  moq                     Int?
  min_bulan_ed            Int?
  informasi_return        String?
  barcode_big             String?
  hb_net                  Float?
  mark_up_purchasing      Float?
  hna                     Float?
  hj_masiva               Float?
  sup1                    String?
  q_temp_out              Int?
  q_exp                   Int?
  disc1                   Float?
  q_akhir                 Int?
  produksi                String?
  het                     Float?
  berat                   Float?
  nie                     String?
  tgl_berlaku_nie         DateTime?
  file_nie                String?
  updated_at              DateTime?
  updated_by              String?
  id_brand                Int?
  deskripsi               String?
  wso2transfer            Boolean?
  is_updated              Boolean?
  kd_cab                  String
  id_dept_pusdis          Int?

  // Relasi
  kategori        MKategori?        @relation(fields: [id_kategori], references: [id_kategori])
  cabang          MCabang           @relation(fields: [kd_cab], references: [kd_cab])
  satuan          MSatuan?          @relation(fields: [id_satuan], references: [id_satuan])
  pabrik          MPabrik?          @relation(fields: [id_pabrik], references: [id])
  kl_produk       MKLProduk?        @relation(fields: [id_kl], references: [id_kl])
  rack_pusdis     MRackPusdis?      @relation(fields: [id_dept_pusdis], references: [id_dept_pusdis])
  TransaksiDetail TransaksiDetail[]

  @@map("tmainstock")
}

model MPabrik {
  id              Int       @id @default(autoincrement())
  nm_pabrik       String
  alamat          String?   @db.Text
  no_telepon      String?   @db.VarChar(20)
  email           String?   @db.VarChar(100)
  no_npwp         String?   @db.VarChar(50)
  nm_npwp         String?
  alamat_npwp     String?   @db.Text
  created_at      DateTime  @default(now())
  deleted_status  Boolean   @default(false)
  deleted_at      DateTime?
  min_bulan_ed    Int?
  informasi_retur String?   @db.Text
  prf_telp        String?   @db.VarChar(20)

  // Add relation to TMainStock since it references id_pabrik
  mainStocks TMainStock[]

  @@map("mpabrik")
}

model MKLProduk {
  id_kl      Int      @id @default(autoincrement())
  nm_kl      String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  // Relation to TMainStock
  mainStocks TMainStock[]

  @@map("mkl_produk")
}

model MRackPusdis {
  id_dept_pusdis Int       @id @default(autoincrement())
  nm_dept        String
  id_kategori    Int?
  parent_id      Int?
  created_at     DateTime  @default(now())
  created_by     String?
  updated_at     DateTime  @updatedAt
  updated_by     String?
  deleted_at     DateTime?
  deleted_by     String?
  is_deleted     Boolean   @default(false)
  nm_kategori    String?

  // Self-relation for parent/child relationship
  parent   MRackPusdis?  @relation("RackPusdisToRackPusdis", fields: [parent_id], references: [id_dept_pusdis])
  children MRackPusdis[] @relation("RackPusdisToRackPusdis")

  // Relation to kategori if needed
  kategori MKategori? @relation(fields: [id_kategori], references: [id_kategori])

  // Add this relation
  mainStocks TMainStock[]

  @@map("mrack_pusdis")
}

model Transaksi {
  id                 Int      @id @default(autoincrement())
  id_pelanggan       Int
  id_dokter          Int
  kd_cab             String
  sales_pelayan      String
  jenis_penjualan    String
  invoice_eksternal  String?
  catatan            String?
  total_harga        Decimal  @db.Decimal(12, 2)
  total_disc         Decimal  @db.Decimal(12, 2)
  total_sc_misc      Decimal  @db.Decimal(12, 2)
  total_promo        Decimal  @db.Decimal(12, 2)
  total_up           Decimal  @db.Decimal(12, 2)
  no_voucher         String?
  interval_transaksi Int?
  buffer_transaksi   Int?
  created_at         DateTime @default(now())
  updated_at         DateTime @updatedAt
  receipt            String?

  // Relations
  pelanggan       Pelanggan         @relation(fields: [id_pelanggan], references: [id])
  dokter          Dokter            @relation(fields: [id_dokter], references: [id])
  cabang          MCabang           @relation(fields: [kd_cab], references: [kd_cab])
  TransaksiDetail TransaksiDetail[]
  antrian         Antrian[]

  @@map("transaksi")
}

model TransaksiDetail {
  id           Int      @id @default(autoincrement())
  id_transaksi Int
  kd_brgdg     Int
  jenis        String // R(resep) atau RC(racikan)
  harga        Decimal  @db.Decimal(10, 2)
  qty          Int
  subjumlah    Decimal  @db.Decimal(12, 2)
  disc         Decimal  @db.Decimal(10, 2)
  sc_misc      Decimal  @db.Decimal(10, 2)
  promo        Decimal  @db.Decimal(10, 2)
  disc_promo   Decimal  @db.Decimal(10, 2)
  up           Decimal  @db.Decimal(10, 2)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  // Relations
  transaksi Transaksi  @relation(fields: [id_transaksi], references: [id])
  mainStock TMainStock @relation(fields: [kd_brgdg], references: [kd_brgdg])

  @@map("transaksi_detail")
}

model Antrian {
  id_antrian     Int       @id @default(autoincrement())
  id_trans       Int?
  id_pelanggan   Int?
  kd_cab         String
  no_antrian     Int?
  type_trans     String?
  mulai          String?
  selesai        String?
  timer          String?
  status_proses  Int?
  user_mulai     String?
  user_selesai   String?
  tgl_update     DateTime?
  status         String?
  status_antrian Boolean?
  tanggal        DateTime?
  status_racik   Boolean?

  // Relations
  transaksi Transaksi? @relation(fields: [id_trans], references: [id])
  cabang    MCabang    @relation(fields: [kd_cab], references: [kd_cab])
  pelanggan Pelanggan? @relation(fields: [id_pelanggan], references: [id])

  @@map("antrian")
}

model Pelanggan {
  id         Int         @id @default(autoincrement())
  nama       String?
  alamat     String?
  no_telp    String?
  usia       Int?
  instansi   String?
  korp       String?
  created_at DateTime    @default(now())
  updated_at DateTime    @updatedAt
  Transaksi  Transaksi[]
  Antrian    Antrian[]

  @@map("pelanggan")
}

model Dokter {
  id           Int         @id @default(autoincrement())
  nama         String?
  alamat       String?
  spesialisasi String?
  created_at   DateTime    @default(now())
  updated_at   DateTime    @updatedAt
  Transaksi    Transaksi[]

  @@map("dokter")
}
